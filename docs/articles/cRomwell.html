<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to the wdlRunR package • wdlRunR</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Google analytics --><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-93043521-1', 'auto');
  ga('send', 'pageview');

</script>
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">wdlRunR</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/seandavi/wdlRunR">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Introduction to the wdlRunR package</h1>
                        <h4 class="author">Sean Davis</h4>
            
            <h4 class="date">2017-04-06</h4>
          </div>

    
    
<div class="contents">
<div id="wdlrunr" class="section level1">
<h1 class="hasAnchor">
<a href="#wdlrunr" class="anchor"></a>wdlRunR</h1>
<p>Follow development at <a href="https://github.com/seandavi/wdlRunR">github</a>.</p>
<p>This package provides a simple api to the <a href="https://github.com/broadinstitute/cromwell">Broad cromwell workflow engine</a>.</p>
<div id="install" class="section level2">
<h2 class="hasAnchor">
<a href="#install" class="anchor"></a>Install</h2>
<p>For the time being, use the <code>develop</code> branch:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">require</span>(devtools)</code></pre></div>
<pre><code>## Loading required package: devtools</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">devtools::<span class="kw">install_github</span>(<span class="st">'seandavi/wdlRunR'</span>, <span class="dt">ref =</span> <span class="st">"develop"</span>)</code></pre></div>
<pre><code>## Skipping install of 'wdlRunR' from a github remote, the SHA1 (d70de8ab) has not changed since last install.
##   Use `force = TRUE` to force installation</code></pre>
</div>
</div>
<div id="background" class="section level1">
<h1 class="hasAnchor">
<a href="#background" class="anchor"></a>Background</h1>
<p><a href="https://en.wikipedia.org/wiki/Big_data">Big Data</a> in biology is a reality. Operating on large-scale biological data, particularly when the data flows require interdependencies and multiple steps, requires smart workflow management tools. Such workflow managers should, ideally:</p>
<ul>
<li>Allow scaling of tasks across available compute infrastructure.</li>
<li>Encourage reproducible research by enabling and encouraging workflows to be described using text files.</li>
<li>Maintain provenance over tools, workflows, inputs, and outputs.</li>
<li>Be robust to failure.</li>
<li>Support restarts and, potentially, work caching to reduce redundant recompute and cost.</li>
<li>Support multiple compute resources, enabling workflow portability and reuse.</li>
</ul>
<p>The <a href="https://github.com/broadinstitute/cromwell">Cromwell</a> is such a workflow system. The <code>[wdlRunR](https://github.com/seandavi/wdlRunR)</code> R package allows users of the R statistical programming environment to interact with the Cromwell workflow system. The wdlRunR R package can act as the “orchestrator” for job submission to the Cromwell workflow system. The R ecosystem provides functionality for documentation, literate programming, publication-quality graphics, statistical analysis, and powerful data and metadata manipulation capabilities. Workflows of nearly arbitrary size to be described and then run using the Cromwell to run large-scale data processing steps, but with the entire workflow, including data munging, workflow metadata management, cloud orchestration and data management, and analysis of processed data described as R code or literate programming documents.</p>
<p>Cromwell is available as a <code>java</code> jarfile and runs as a server or as a command-line executor of single workflows. This package is focused on interacting with Cromwell as a server and accessing it via its <a href="https://github.com/broadinstitute/cromwell#rest-api">documented REST API</a>.</p>
<p>Cromwell jobs are described using Workflow Description Language (WDL). WDL resources are available:</p>
<ul>
<li><a href="https://github.com/broadinstitute/wdl">WDL github site</a></li>
<li><a href="https://software.broadinstitute.org/wdl/">WDL software and tutorial site at the Broad</a></li>
</ul>
</div>
<div id="getting-started" class="section level1">
<h1 class="hasAnchor">
<a href="#getting-started" class="anchor"></a>Getting started</h1>
<p>As a first step, we download the current released version of Cromwell. We then run the server and put the log file into a <code>tempdir()</code> using R code and a call to <code>system()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(wdlRunR)
cromwell_jar =<span class="st"> </span><span class="kw"><a href="../reference/getCromwellJar.html">getCromwellJar</a></span>(<span class="dt">cromwell_version=</span><span class="st">'24'</span>)
cromwell_log =<span class="st"> </span><span class="kw">file.path</span>(<span class="kw">tempdir</span>(),<span class="st">'cromwell.log'</span>)
<span class="kw">system</span>(<span class="kw">sprintf</span>(<span class="st">'java -jar %s server &gt; %s 2&gt;&amp;1 &amp;'</span>, cromwell_jar, cromwell_log))
<span class="co"># let server start up</span>
<span class="kw">Sys.sleep</span>(<span class="dv">20</span>)</code></pre></div>
<p>Cromwell should now be running in the background and we can verify by checking for processes with “cromwell” in the name.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system</span>(<span class="st">'ps aux | grep cromwell'</span>)</code></pre></div>
</div>
<div id="workflows" class="section level1">
<h1 class="hasAnchor">
<a href="#workflows" class="anchor"></a>Workflows</h1>
<p>The simplest example (and one that runs in the time needed for a demo!) is a “Hello, WDL” workflow. Right now, we simply describe a WDL workflow as text or as a text file (see below).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">hello_wdl =<span class="st"> "task hello {</span>
<span class="st">  String name</span>

<span class="st">  command {</span>
<span class="st">    echo 'Hello ${name}!'</span>
<span class="st">  }</span>
<span class="st">  output {</span>
<span class="st">    File response = stdout()</span>
<span class="st">  }</span>
<span class="st">}</span>

<span class="st">workflow test {</span>
<span class="st">  call hello</span>
<span class="st">}"</span></code></pre></div>
<div id="submit-a-batch-job" class="section level2">
<h2 class="hasAnchor">
<a href="#submit-a-batch-job" class="anchor"></a>Submit a batch job</h2>
<p>We are going to submit a batch of jobs (10 of them) with randomly-generated names. The input to the <code><a href="../reference/cromwellBatch.html">cromwellBatch()</a></code> function is a <code>data.frame</code> with columns named for the WDL inputs. Each row of the <code>data.frame</code> will become a workflow that will be run (locally in this case) by Cromwell.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">options</span>(<span class="dt">cromwell_base =</span> <span class="st">'http://localhost:8000'</span>)
randomStrings =<span class="st"> </span><span class="kw">sapply</span>(<span class="dv">1</span>:<span class="dv">10</span>,function(r) {<span class="kw">paste</span>(<span class="kw">sample</span>(LETTERS,<span class="dv">10</span>),<span class="dt">collapse=</span><span class="st">""</span>)})
wdlInputs =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">test.hello.name=</span>randomStrings)</code></pre></div>
<p>We can submit a batch of jobs to cromwell by simply posting to the correct API endpoint and the function <code><a href="../reference/cromwellBatch.html">cromwellBatch()</a></code> wraps this process in R.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">res =<span class="st"> </span><span class="kw"><a href="../reference/cromwellBatch.html">cromwellBatch</a></span>(<span class="dt">wdlSource =</span> hello_wdl,<span class="dt">workflowInputs=</span>wdlInputs)
<span class="co"># and we do this to allow the jobs to get running</span>
<span class="kw">Sys.sleep</span>(<span class="dv">20</span>)</code></pre></div>
</div>
<div id="monitoring-jobs" class="section level2">
<h2 class="hasAnchor">
<a href="#monitoring-jobs" class="anchor"></a>Monitoring jobs</h2>
<p>Once jobs are submitted, they will enter the Cromwell workflow monitoring system. We can query this system at any time. Look at the <a href="">API documentation</a> and <code>help('cromwellQuery')</code> in R for some more details.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/cromwellQuery.html">cromwellQuery</a></span>()</code></pre></div>
<p>We can use any R functionality to manage our WDL and inputs. For example, we can get a WDL workflow from a <a href="https://github.com/DockstoreTestUser/dockstore-whalesay/blob/master/Dockstore.wdl">github-hosted</a> WDL workflow. Here is an example of using the same “Hello, WDL” workflow.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#read from github or other URL</span>
<span class="kw">library</span>(httr)
hello_remote_wdl =<span class="st"> </span><span class="kw">content</span>(<span class="kw">GET</span>(<span class="st">"https://raw.githubusercontent.com/DockstoreTestUser/dockstore-whalesay/master/Dockstore.wdl"</span>),<span class="st">'text'</span>)</code></pre></div>
<p>And we can use R for creating inputs in any way we like. Here, we use the <a href="https://cran.r-project.org/package=babynames">babynames R package</a> to set the names.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">if(<span class="kw">require</span>(babynames))
    wdlInputs =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">test.hello.name=</span><span class="kw">sample</span>(babynames$name,<span class="dv">10</span>))
z =<span class="st"> </span><span class="kw"><a href="../reference/cromwellBatch.html">cromwellBatch</a></span>(<span class="dt">wdlSource =</span> hello_remote_wdl,<span class="dt">workflowInputs=</span>wdlInputs)
<span class="kw">Sys.sleep</span>(<span class="dv">20</span>)
<span class="kw"><a href="../reference/cromwellQuery.html">cromwellQuery</a></span>()</code></pre></div>
<p>To make things a bit more interesting, we can simulate long-running jobs using a “sleeping” variation of “Hello, WDL.”</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">hello_wdl_sleep =<span class="st"> "task hello {</span>
<span class="st">  String name</span>

<span class="st">  command {</span>
<span class="st">    echo 'Hello ${name}!' &amp;&amp; sleep 60</span>
<span class="st">  }</span>
<span class="st">  output {</span>
<span class="st">    File response = stdout()</span>
<span class="st">  }</span>
<span class="st">}</span>

<span class="st">workflow test {</span>
<span class="st">  call hello</span>
<span class="st">}"</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">randomStrings =<span class="st"> </span><span class="kw">sapply</span>(<span class="dv">1</span>:<span class="dv">10</span>,function(r) {<span class="kw">paste</span>(<span class="kw">sample</span>(LETTERS,<span class="dv">10</span>),<span class="dt">collapse=</span><span class="st">""</span>)})
wdlInputs =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">test.hello.name=</span>randomStrings)
z =<span class="st"> </span><span class="kw"><a href="../reference/cromwellBatch.html">cromwellBatch</a></span>(<span class="dt">wdlSource =</span> hello_wdl_sleep,<span class="dt">workflowInputs=</span>wdlInputs)
<span class="co"># to let Cromwell get started with the jobs.</span>
<span class="kw">sleep</span>(<span class="dv">10</span>)</code></pre></div>
<p>At this point, checking <code><a href="../reference/cromwellQuery.html">cromwellQuery()</a></code> will show running jobs (if done within 60 seconds, of course). Limiting to “Running” jobs is also easy.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/cromwellQuery.html">cromwellQuery</a></span>(<span class="dt">term=</span><span class="st">"status=Running"</span>)</code></pre></div>
<p>And we can check for outputs as well.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">results =<span class="st"> </span><span class="kw"><a href="../reference/cromwellQuery.html">cromwellQuery</a></span>(<span class="dt">term=</span><span class="st">"status=Succeeded"</span>)
outputs =<span class="st"> </span><span class="kw"><a href="../reference/cromwellOutputs.html">cromwellOutputs</a></span>(results$id)
<span class="kw">str</span>(outputs,<span class="dt">list.len=</span><span class="dv">4</span>)
<span class="kw">readLines</span>(outputs[[<span class="dv">1</span>]]$outputs$test_hello_response)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">logs =<span class="st"> </span><span class="kw"><a href="../reference/cromwellLogs.html">cromwellLogs</a></span>(results$id)
<span class="co"># stderr -- should be empty for this task</span>
<span class="kw">readLines</span>(logs[[<span class="dv">1</span>]]$test.hello[[<span class="dv">1</span>]]$stderr)
<span class="co"># stdout</span>
<span class="kw">readLines</span>(logs[[<span class="dv">1</span>]]$test.hello[[<span class="dv">1</span>]]$stdout)</code></pre></div>
</div>
</div>
<div id="cleanup" class="section level1">
<h1 class="hasAnchor">
<a href="#cleanup" class="anchor"></a>cleanup</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># messy!</span>
<span class="kw">unlink</span>(cromwell_jar)
<span class="kw">unlink</span>(cromwell_log)
<span class="kw">system</span>(<span class="st">'pgrep -f cromwell | xargs -I {} kill -9 {}'</span>)</code></pre></div>
</div>
<div id="sessioninfo" class="section level1">
<h1 class="hasAnchor">
<a href="#sessioninfo" class="anchor"></a>sessionInfo</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sessionInfo</span>()</code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#wdlrunr">wdlRunR</a><ul class="nav nav-pills nav-stacked">
<li><a href="#install">Install</a></li>
      </ul>
</li>
      <li><a href="#background">Background</a></li>
      <li><a href="#getting-started">Getting started</a></li>
      <li>
<a href="#workflows">Workflows</a><ul class="nav nav-pills nav-stacked">
<li><a href="#submit-a-batch-job">Submit a batch job</a></li>
      <li><a href="#monitoring-jobs">Monitoring jobs</a></li>
      </ul>
</li>
      <li><a href="#cleanup">cleanup</a></li>
      <li><a href="#sessioninfo">sessionInfo</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Sean Davis.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
